# AI 音樂助手架構設計文檔

## 整體架構

AI 音樂助手採用分層架構設計，確保各組件間的解耦和可擴展性。系統包含三個主要層級：

```
AI音樂助手
├── 前端層
│   ├── 使用者介面
│   ├── 音訊輸入處理
│   └── 視覺化與播放
├── 中間層 (MCP協議層)
│   ├── 指令解析器
│   ├── 模型協調器
│   └── 資料轉換器
└── 後端層
    ├── 語言模型服務
    ├── 音樂生成服務
    ├── 樂理分析服務
    ├── 音訊處理服務
    └── 渲染與輸出服務
```

## 核心概念

### Model Context Protocol (MCP)

MCP 是系統的核心協議，定義了不同模型和工具之間的標準化溝通格式。它包含：

- **指令格式**：將使用者意圖轉換為標準化指令
- **參數規範**：音樂相關參數的統一表示
- **響應格式**：模型輸出的標準化格式

MCP 使系統能夠靈活更換底層模型和工具，同時保持接口的一致性。

## 前端層

### 使用者介面

- **技術選型**：React + TypeScript + Material UI
- **核心元件**：
  - 文字輸入/音頻錄製界面
  - 音樂播放器/可視化元件
  - 樂譜顯示
  - 參數調整控制項

### 音訊輸入處理

- 麥克風錄音功能 (使用 Web Audio API)
- 即時音訊轉 Base64 編碼
- MIDI 鍵盤輸入支援

### 視覺化與播放

- 整合 Tone.js 進行音訊播放
- 使用 VexFlow/MuseScore Web 進行樂譜渲染
- 波形與頻譜圖示視覺化

## MCP 協議層

### 指令解析器

- **文字解析**：將自然語言轉換為結構化指令
- **音頻解析**：處理音頻輸入並提取相關參數
- **指令規範化**：確保指令格式符合 MCP 標準

### 模型協調器

- **工作流程管理**：根據指令類型選擇相應工作流程
- **模型調用策略**：協調不同模型的呼叫順序與數據流
- **錯誤處理與恢復**：處理模型調用過程中的異常情況

### 資料轉換器

- **格式轉換**：在不同數據格式間進行轉換 (MIDI, MusicXML, 音頻等)
- **數據規範化**：標準化模型輸入輸出

## 後端層

### 語言模型服務

- **模型選型**：使用開源 LLM (如 Llama)
- **音樂領域微調**：針對音樂創作場景優化
- **接口適配**：轉換模型輸出為 MCP 格式

### 音樂生成服務

- **整合 Magenta**：用於旋律和和聲生成
- **擴展模型**：支援多種音樂生成策略
- **品質控制**：確保生成音樂的品質與多樣性

### 樂理分析服務

- **整合 Music21**：進行音樂理論分析
- **和聲推理**：使用 AugmentedNet 進行和聲分析與生成
- **結構分析**：識別音樂結構與段落

### 音訊處理服務

- **整合 Basic Pitch**：將音頻轉換為 MIDI
- **音準校正**：提供自然的音準修正功能
- **音訊轉錄**：多聲部音頻的音符轉錄

### 渲染與輸出服務

- **MIDI 渲染**：使用 Dexed/OctaSine 進行音色渲染
- **樂譜生成**：使用 MuseScore 生成標準化樂譜
- **文件輸出**：支援多種音樂文件格式

## 數據流程設計

### 案例一：文字到音樂生成

```
使用者輸入 → MCP指令解析 → 音樂參數提取 → LLM生成音樂概念
→ Magenta生成 → 樂理驗證 → 音色渲染 → 樂譜生成 → 輸出
```

### 案例二：旋律哼唱到編曲

```
錄音輸入 → 音準校正 → Basic Pitch轉MIDI → 樂理分析 → 和聲生成
→ 編曲擴展 → 音色渲染 → 樂譜生成 → 輸出
```

## 擴展性設計

### 模型替換機制

系統設計支援在不修改核心架構的情況下替換底層模型：

1. **模型抽象層**：所有模型都通過統一接口集成
2. **配置驅動**：通過配置文件指定使用的模型實現
3. **插件架構**：支援動態加載新模型

### 功能擴展點

- **新指令類型**：擴展 MCP 指令類型以支援新功能
- **自定義工作流程**：支援定義新的處理流程
- **音色庫擴展**：加入新的音色渲染引擎

## 部署架構

### 開發環境

- **前端**：Vite 開發服務器
- **後端**：FastAPI 開發服務器
- **模型**：本地運行小型模型，大型模型使用 API 調用

### 生產環境

- **前端部署**：靜態文件託管 (GitHub Pages, Vercel 等)
- **後端部署**：容器化部署 (Docker)
- **模型服務**：根據資源需求選擇本地部署或雲服務

## 性能優化策略

- **模型量化**：使用量化版本的語言模型減少資源需求
- **響應緩存**：相似指令的結果緩存
- **異步處理**：長時間運行的任務使用異步處理
- **增量生成**：大型音樂作品採用增量方式生成

## 安全考量

- **輸入驗證**：嚴格驗證所有用戶輸入
- **資源限制**：對計算密集型任務設置資源上限
- **數據保護**：用戶上傳的音頻和生成的音樂適當保護

## 未來擴展方向

- **協作功能**：支援多人實時協同創作
- **風格遷移**：添加音樂風格轉換功能
- **歌聲合成**：集成開源歌聲合成工具
- **個性化學習**：基於用戶喜好調整生成模型 